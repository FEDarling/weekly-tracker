<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JavaScript引擎基础(下)：优化原型 | Weekly Tracker</title>
    <meta name="generator" content="VuePress 1.9.7">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?42838d5683674819691a92f6ebdf25d8";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
      </script>        
      </script>
    <meta name="description" content="追踪国外最流行的周刊">
    
    <link rel="preload" href="/assets/css/0.styles.df856fea.css" as="style"><link rel="preload" href="/assets/js/app.753e2338.js" as="script"><link rel="preload" href="/assets/js/4.c9e0fe93.js" as="script"><link rel="preload" href="/assets/js/1.fdc351be.js" as="script"><link rel="preload" href="/assets/js/95.349d6786.js" as="script"><link rel="preload" href="/assets/js/10.830b4516.js" as="script"><link rel="prefetch" href="/assets/js/100.6b3e0ec3.js"><link rel="prefetch" href="/assets/js/101.2c8842f6.js"><link rel="prefetch" href="/assets/js/102.ad3df0d1.js"><link rel="prefetch" href="/assets/js/103.ebfb7fec.js"><link rel="prefetch" href="/assets/js/104.5db97244.js"><link rel="prefetch" href="/assets/js/105.789fe30b.js"><link rel="prefetch" href="/assets/js/106.10e61e2f.js"><link rel="prefetch" href="/assets/js/107.14443297.js"><link rel="prefetch" href="/assets/js/108.5a58e519.js"><link rel="prefetch" href="/assets/js/109.ab526113.js"><link rel="prefetch" href="/assets/js/11.16bc7ca3.js"><link rel="prefetch" href="/assets/js/110.6904573b.js"><link rel="prefetch" href="/assets/js/111.3fe45f8f.js"><link rel="prefetch" href="/assets/js/112.fe97363f.js"><link rel="prefetch" href="/assets/js/113.0fd31e28.js"><link rel="prefetch" href="/assets/js/114.ad03ee65.js"><link rel="prefetch" href="/assets/js/115.8a413da1.js"><link rel="prefetch" href="/assets/js/116.b1fae3cf.js"><link rel="prefetch" href="/assets/js/117.3e0c21e2.js"><link rel="prefetch" href="/assets/js/118.33dc4acb.js"><link rel="prefetch" href="/assets/js/119.a560f4bf.js"><link rel="prefetch" href="/assets/js/12.23851441.js"><link rel="prefetch" href="/assets/js/120.eaf01819.js"><link rel="prefetch" href="/assets/js/121.475a2a17.js"><link rel="prefetch" href="/assets/js/122.138bddcc.js"><link rel="prefetch" href="/assets/js/123.efd903e9.js"><link rel="prefetch" href="/assets/js/124.0257d11c.js"><link rel="prefetch" href="/assets/js/125.0ae2d588.js"><link rel="prefetch" href="/assets/js/126.9be66087.js"><link rel="prefetch" href="/assets/js/127.71b828ab.js"><link rel="prefetch" href="/assets/js/128.3aaccbe7.js"><link rel="prefetch" href="/assets/js/129.aebe8782.js"><link rel="prefetch" href="/assets/js/13.5bdf3bdd.js"><link rel="prefetch" href="/assets/js/130.88c9eab0.js"><link rel="prefetch" href="/assets/js/131.9e10f5f3.js"><link rel="prefetch" href="/assets/js/132.b6921c29.js"><link rel="prefetch" href="/assets/js/133.85182b91.js"><link rel="prefetch" href="/assets/js/134.58457997.js"><link rel="prefetch" href="/assets/js/135.fd6af072.js"><link rel="prefetch" href="/assets/js/136.7e5abce8.js"><link rel="prefetch" href="/assets/js/137.b877464c.js"><link rel="prefetch" href="/assets/js/138.836d4f3d.js"><link rel="prefetch" href="/assets/js/139.8a1e9ea4.js"><link rel="prefetch" href="/assets/js/14.5cef0163.js"><link rel="prefetch" href="/assets/js/140.69489ff6.js"><link rel="prefetch" href="/assets/js/141.64ffd0c9.js"><link rel="prefetch" href="/assets/js/142.a2d20c58.js"><link rel="prefetch" href="/assets/js/143.dca7cb7d.js"><link rel="prefetch" href="/assets/js/144.baecc045.js"><link rel="prefetch" href="/assets/js/145.a7affed9.js"><link rel="prefetch" href="/assets/js/146.df293618.js"><link rel="prefetch" href="/assets/js/147.36f7d18e.js"><link rel="prefetch" href="/assets/js/148.4b92b4f4.js"><link rel="prefetch" href="/assets/js/149.6df4c04f.js"><link rel="prefetch" href="/assets/js/15.91858bc2.js"><link rel="prefetch" href="/assets/js/150.90aa5f92.js"><link rel="prefetch" href="/assets/js/151.0bafaa2a.js"><link rel="prefetch" href="/assets/js/152.f84247a0.js"><link rel="prefetch" href="/assets/js/153.96284f30.js"><link rel="prefetch" href="/assets/js/154.38b315f2.js"><link rel="prefetch" href="/assets/js/155.c50bb540.js"><link rel="prefetch" href="/assets/js/156.337a030d.js"><link rel="prefetch" href="/assets/js/157.1fdc4560.js"><link rel="prefetch" href="/assets/js/158.87cda35d.js"><link rel="prefetch" href="/assets/js/159.8604032e.js"><link rel="prefetch" href="/assets/js/16.fec23e3e.js"><link rel="prefetch" href="/assets/js/160.37bb4cd9.js"><link rel="prefetch" href="/assets/js/161.e876d055.js"><link rel="prefetch" href="/assets/js/162.3b17b4e5.js"><link rel="prefetch" href="/assets/js/163.f8ed2597.js"><link rel="prefetch" href="/assets/js/164.b2074699.js"><link rel="prefetch" href="/assets/js/165.95063448.js"><link rel="prefetch" href="/assets/js/166.8e081e06.js"><link rel="prefetch" href="/assets/js/167.86c21232.js"><link rel="prefetch" href="/assets/js/168.8e5654a6.js"><link rel="prefetch" href="/assets/js/169.8bf35561.js"><link rel="prefetch" href="/assets/js/17.656a837e.js"><link rel="prefetch" href="/assets/js/170.bcd6be25.js"><link rel="prefetch" href="/assets/js/171.6b17a2a2.js"><link rel="prefetch" href="/assets/js/172.eba03431.js"><link rel="prefetch" href="/assets/js/173.3a932b04.js"><link rel="prefetch" href="/assets/js/174.8e97be1b.js"><link rel="prefetch" href="/assets/js/175.c5d132b1.js"><link rel="prefetch" href="/assets/js/176.0ab3ea76.js"><link rel="prefetch" href="/assets/js/177.f972770c.js"><link rel="prefetch" href="/assets/js/178.9c19cd5d.js"><link rel="prefetch" href="/assets/js/179.1f7527fe.js"><link rel="prefetch" href="/assets/js/18.1ac271d3.js"><link rel="prefetch" href="/assets/js/180.f8620634.js"><link rel="prefetch" href="/assets/js/181.cba1fb2a.js"><link rel="prefetch" href="/assets/js/182.8298849a.js"><link rel="prefetch" href="/assets/js/183.f4558eaa.js"><link rel="prefetch" href="/assets/js/184.76fbc11b.js"><link rel="prefetch" href="/assets/js/185.e68a5bba.js"><link rel="prefetch" href="/assets/js/186.4bac1cf6.js"><link rel="prefetch" href="/assets/js/187.102c242e.js"><link rel="prefetch" href="/assets/js/188.07f55ecf.js"><link rel="prefetch" href="/assets/js/189.c49ce3d4.js"><link rel="prefetch" href="/assets/js/19.49397e79.js"><link rel="prefetch" href="/assets/js/190.47e264be.js"><link rel="prefetch" href="/assets/js/191.5971256e.js"><link rel="prefetch" href="/assets/js/192.38ae1144.js"><link rel="prefetch" href="/assets/js/193.56c1324d.js"><link rel="prefetch" href="/assets/js/194.5133054d.js"><link rel="prefetch" href="/assets/js/195.ae9fa214.js"><link rel="prefetch" href="/assets/js/196.8189120f.js"><link rel="prefetch" href="/assets/js/197.cbb1f39c.js"><link rel="prefetch" href="/assets/js/198.b8496199.js"><link rel="prefetch" href="/assets/js/199.23e97b5e.js"><link rel="prefetch" href="/assets/js/2.667d6af0.js"><link rel="prefetch" href="/assets/js/20.cb982b00.js"><link rel="prefetch" href="/assets/js/200.3481222c.js"><link rel="prefetch" href="/assets/js/201.fceb577f.js"><link rel="prefetch" href="/assets/js/202.b656b1b9.js"><link rel="prefetch" href="/assets/js/203.23b4daf6.js"><link rel="prefetch" href="/assets/js/204.55495f9c.js"><link rel="prefetch" href="/assets/js/205.c04f619b.js"><link rel="prefetch" href="/assets/js/206.49a7ff70.js"><link rel="prefetch" href="/assets/js/207.39f0121a.js"><link rel="prefetch" href="/assets/js/208.e44f7188.js"><link rel="prefetch" href="/assets/js/209.acaacc89.js"><link rel="prefetch" href="/assets/js/21.82156d86.js"><link rel="prefetch" href="/assets/js/210.82316d6f.js"><link rel="prefetch" href="/assets/js/211.a9d8f767.js"><link rel="prefetch" href="/assets/js/212.ffdf2ce7.js"><link rel="prefetch" href="/assets/js/213.8f3dde06.js"><link rel="prefetch" href="/assets/js/214.890e5481.js"><link rel="prefetch" href="/assets/js/215.dd09274e.js"><link rel="prefetch" href="/assets/js/216.5a360e2b.js"><link rel="prefetch" href="/assets/js/217.689264d0.js"><link rel="prefetch" href="/assets/js/218.afbf6122.js"><link rel="prefetch" href="/assets/js/219.80b8d8d9.js"><link rel="prefetch" href="/assets/js/22.de850eb9.js"><link rel="prefetch" href="/assets/js/220.641bb904.js"><link rel="prefetch" href="/assets/js/221.cae2319a.js"><link rel="prefetch" href="/assets/js/222.a1020229.js"><link rel="prefetch" href="/assets/js/223.edec41df.js"><link rel="prefetch" href="/assets/js/224.1ea93d3b.js"><link rel="prefetch" href="/assets/js/225.ce0bcf44.js"><link rel="prefetch" href="/assets/js/226.efc5c785.js"><link rel="prefetch" href="/assets/js/227.81cf2ee9.js"><link rel="prefetch" href="/assets/js/228.d3b82e45.js"><link rel="prefetch" href="/assets/js/229.86c55fe1.js"><link rel="prefetch" href="/assets/js/23.9d14b7e6.js"><link rel="prefetch" href="/assets/js/230.d8218bfc.js"><link rel="prefetch" href="/assets/js/231.73f5464a.js"><link rel="prefetch" href="/assets/js/232.8241fec7.js"><link rel="prefetch" href="/assets/js/233.8e77c9fe.js"><link rel="prefetch" href="/assets/js/234.1da0d6c1.js"><link rel="prefetch" href="/assets/js/235.174797d0.js"><link rel="prefetch" href="/assets/js/236.8a649ca4.js"><link rel="prefetch" href="/assets/js/237.9303059a.js"><link rel="prefetch" href="/assets/js/238.713eef7b.js"><link rel="prefetch" href="/assets/js/239.577f7091.js"><link rel="prefetch" href="/assets/js/24.7263dac5.js"><link rel="prefetch" href="/assets/js/240.8fdcf95a.js"><link rel="prefetch" href="/assets/js/241.d0f11c83.js"><link rel="prefetch" href="/assets/js/242.5569dbd1.js"><link rel="prefetch" href="/assets/js/243.636a5829.js"><link rel="prefetch" href="/assets/js/244.69d5cad4.js"><link rel="prefetch" href="/assets/js/245.09cff17f.js"><link rel="prefetch" href="/assets/js/25.6c3cc1c1.js"><link rel="prefetch" href="/assets/js/26.d65fb15d.js"><link rel="prefetch" href="/assets/js/27.735c1e4f.js"><link rel="prefetch" href="/assets/js/28.8e122b02.js"><link rel="prefetch" href="/assets/js/29.f80a235e.js"><link rel="prefetch" href="/assets/js/30.118841db.js"><link rel="prefetch" href="/assets/js/31.ff0fc2a4.js"><link rel="prefetch" href="/assets/js/32.6c12b702.js"><link rel="prefetch" href="/assets/js/33.fecff164.js"><link rel="prefetch" href="/assets/js/34.6c4d1ace.js"><link rel="prefetch" href="/assets/js/35.8c1391a2.js"><link rel="prefetch" href="/assets/js/36.78896e5b.js"><link rel="prefetch" href="/assets/js/37.5ed29496.js"><link rel="prefetch" href="/assets/js/38.0b1404d5.js"><link rel="prefetch" href="/assets/js/39.97ca825a.js"><link rel="prefetch" href="/assets/js/40.f50d959a.js"><link rel="prefetch" href="/assets/js/41.9fb6ba76.js"><link rel="prefetch" href="/assets/js/42.737dfba1.js"><link rel="prefetch" href="/assets/js/43.78a01e9e.js"><link rel="prefetch" href="/assets/js/44.1a229448.js"><link rel="prefetch" href="/assets/js/45.fd1c11b8.js"><link rel="prefetch" href="/assets/js/46.dd14ab4e.js"><link rel="prefetch" href="/assets/js/47.c31fa5af.js"><link rel="prefetch" href="/assets/js/48.64611393.js"><link rel="prefetch" href="/assets/js/49.41602881.js"><link rel="prefetch" href="/assets/js/5.b0daf45f.js"><link rel="prefetch" href="/assets/js/50.471b93b3.js"><link rel="prefetch" href="/assets/js/51.46bc7429.js"><link rel="prefetch" href="/assets/js/52.577e5d5b.js"><link rel="prefetch" href="/assets/js/53.8dc2df53.js"><link rel="prefetch" href="/assets/js/54.d8905c3e.js"><link rel="prefetch" href="/assets/js/55.991662a4.js"><link rel="prefetch" href="/assets/js/56.64cbea21.js"><link rel="prefetch" href="/assets/js/57.7d0ccef5.js"><link rel="prefetch" href="/assets/js/58.4f598392.js"><link rel="prefetch" href="/assets/js/59.76f4c838.js"><link rel="prefetch" href="/assets/js/6.28cb02fd.js"><link rel="prefetch" href="/assets/js/60.944da0d2.js"><link rel="prefetch" href="/assets/js/61.da28081d.js"><link rel="prefetch" href="/assets/js/62.9c061a8c.js"><link rel="prefetch" href="/assets/js/63.b05aa92a.js"><link rel="prefetch" href="/assets/js/64.f4eed7f5.js"><link rel="prefetch" href="/assets/js/65.c5b4d4d8.js"><link rel="prefetch" href="/assets/js/66.88134142.js"><link rel="prefetch" href="/assets/js/67.d6ed5584.js"><link rel="prefetch" href="/assets/js/68.3c826a7b.js"><link rel="prefetch" href="/assets/js/69.8cb6ce7f.js"><link rel="prefetch" href="/assets/js/7.89ba5420.js"><link rel="prefetch" href="/assets/js/70.d7a6f725.js"><link rel="prefetch" href="/assets/js/71.afcbedd9.js"><link rel="prefetch" href="/assets/js/72.41340f5b.js"><link rel="prefetch" href="/assets/js/73.8df926e0.js"><link rel="prefetch" href="/assets/js/74.3279fa5a.js"><link rel="prefetch" href="/assets/js/75.1b52f91e.js"><link rel="prefetch" href="/assets/js/76.74364b58.js"><link rel="prefetch" href="/assets/js/77.b00f3f08.js"><link rel="prefetch" href="/assets/js/78.f6ff6ddc.js"><link rel="prefetch" href="/assets/js/79.4df80914.js"><link rel="prefetch" href="/assets/js/8.6c92a4c3.js"><link rel="prefetch" href="/assets/js/80.99f7c74f.js"><link rel="prefetch" href="/assets/js/81.f441d58d.js"><link rel="prefetch" href="/assets/js/82.f1c9e53f.js"><link rel="prefetch" href="/assets/js/83.421fb606.js"><link rel="prefetch" href="/assets/js/84.7c64155a.js"><link rel="prefetch" href="/assets/js/85.231a2b2d.js"><link rel="prefetch" href="/assets/js/86.33399d77.js"><link rel="prefetch" href="/assets/js/87.f79e2506.js"><link rel="prefetch" href="/assets/js/88.62054b72.js"><link rel="prefetch" href="/assets/js/89.357136d8.js"><link rel="prefetch" href="/assets/js/9.d72b7ad7.js"><link rel="prefetch" href="/assets/js/90.336bacd9.js"><link rel="prefetch" href="/assets/js/91.3a788ee8.js"><link rel="prefetch" href="/assets/js/92.2c7da18c.js"><link rel="prefetch" href="/assets/js/93.8343e793.js"><link rel="prefetch" href="/assets/js/94.1218e7b4.js"><link rel="prefetch" href="/assets/js/96.3f279031.js"><link rel="prefetch" href="/assets/js/97.8d567112.js"><link rel="prefetch" href="/assets/js/98.8eba0e8d.js"><link rel="prefetch" href="/assets/js/99.9d65c958.js">
    <link rel="stylesheet" href="/assets/css/0.styles.df856fea.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-130b300a><div data-v-130b300a><div class="password-shadow password-wrapper-out" style="display:none;" data-v-25ba6db2 data-v-130b300a data-v-130b300a><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>Weekly Tracker</h3> <p class="description" data-v-25ba6db2 data-v-25ba6db2>追踪国外最流行的周刊</p> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><!---->
            
          <!---->
          2022
        </a></span></div></div> <div class="hide" data-v-130b300a><header class="navbar" data-v-130b300a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/organization.png" alt="Weekly Tracker" class="logo"> <span class="site-name">Weekly Tracker</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  最新文章
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      所有周刊
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/CSS Weekly/" class="nav-link"><i class="undefined"></i>
  CSS Weekly
</a></li><li class="dropdown-item"><!----> <a href="/categories/Frontend Focus/" class="nav-link"><i class="undefined"></i>
  Frontend Focus
</a></li><li class="dropdown-item"><!----> <a href="/categories/JavaScript Weekly/" class="nav-link"><i class="undefined"></i>
  JavaScript Weekly
</a></li><li class="dropdown-item"><!----> <a href="/categories/Mobile Dev Weekly/" class="nav-link"><i class="undefined"></i>
  Mobile Dev Weekly
</a></li><li class="dropdown-item"><!----> <a href="/categories/Node Weekly/" class="nav-link"><i class="undefined"></i>
  Node Weekly
</a></li><li class="dropdown-item"><!----> <a href="/categories/React Status/" class="nav-link"><i class="undefined"></i>
  React Status
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  精选文章
</a></div><div class="nav-item"><a href="https://github.com/FEDarling/weekly-tracker" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://weekly.fedarling.com/rss.xml" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-bokeyuan"></i>
  RSS
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-130b300a></div> <aside class="sidebar" data-v-130b300a><div class="personal-info-wrapper" data-v-39576ba9 data-v-130b300a><!----> <!----> <div class="num" data-v-39576ba9><div data-v-39576ba9><h3 data-v-39576ba9>72</h3> <h6 data-v-39576ba9>文章</h6></div> <div data-v-39576ba9><h3 data-v-39576ba9>22</h3> <h6 data-v-39576ba9>标签</h6></div></div> <ul class="social-links" data-v-39576ba9></ul> <hr data-v-39576ba9></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  最新文章
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      所有周刊
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/CSS Weekly/" class="nav-link"><i class="undefined"></i>
  CSS Weekly
</a></li><li class="dropdown-item"><!----> <a href="/categories/Frontend Focus/" class="nav-link"><i class="undefined"></i>
  Frontend Focus
</a></li><li class="dropdown-item"><!----> <a href="/categories/JavaScript Weekly/" class="nav-link"><i class="undefined"></i>
  JavaScript Weekly
</a></li><li class="dropdown-item"><!----> <a href="/categories/Mobile Dev Weekly/" class="nav-link"><i class="undefined"></i>
  Mobile Dev Weekly
</a></li><li class="dropdown-item"><!----> <a href="/categories/Node Weekly/" class="nav-link"><i class="undefined"></i>
  Node Weekly
</a></li><li class="dropdown-item"><!----> <a href="/categories/React Status/" class="nav-link"><i class="undefined"></i>
  React Status
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  精选文章
</a></div><div class="nav-item"><a href="https://github.com/FEDarling/weekly-tracker" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://weekly.fedarling.com/rss.xml" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-bokeyuan"></i>
  RSS
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <ul class="sidebar-links"><li><a href="/javascript_weekly/578/" class="sidebar-link">JavaScript Weekly #578</a></li><li><a href="/javascript_weekly/577/" class="sidebar-link">JavaScript Weekly #577</a></li><li><a href="/javascript_weekly/576/" class="sidebar-link">JavaScript Weekly #576</a></li><li><a href="/javascript_weekly/575/" class="sidebar-link">JavaScript Weekly #575</a></li><li><a href="/javascript_weekly/574/" class="sidebar-link">JavaScript Weekly #574</a></li><li><a href="/javascript_weekly/573/" class="sidebar-link">JavaScript Weekly #573</a></li><li><a href="/javascript_weekly/572/" class="sidebar-link">JavaScript Weekly #572</a></li><li><section class="sidebar-group depth-0"><a href="/javascript_weekly/571/" class="sidebar-heading clickable"><span>JavaScript Weekly #571</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/javascript_weekly/571/Is_It_Time_for_the_JavaScript_Temporal_API.html" class="sidebar-link">是开始使用 JavaScript Temporal API 的时候了吗？</a></li><li><a href="/javascript_weekly/571/flatMap.html" class="sidebar-link">Array.flatMap：一个灵活好用的 Map 方法</a></li><li><a href="/javascript_weekly/571/fuite.html" class="sidebar-link">Fuite：监测 web 应用中内存泄漏的工具</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/javascript_weekly/570/" class="sidebar-heading clickable"><span>JavaScript Weekly #570</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/javascript_weekly/570/ES2021_new_feature.html" class="sidebar-link">ES2021 新特性</a></li><li><a href="/javascript_weekly/570/build_tools_compare.html" class="sidebar-link">新一代构建工具对比</a></li><li><a href="/javascript_weekly/570/svelte_vs_react.html" class="sidebar-link">比较 Svelte 和 React</a></li><li><a href="/javascript_weekly/570/ternary.html" class="sidebar-link">重新思考 JavaScript 的三元运算符</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/javascript_weekly/554/" class="sidebar-heading clickable"><span>JavaScript Weekly #554</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/javascript_weekly/554/ES2022_Feature_Class_Static_Initialization_Blocks.html" class="sidebar-link">ES2022 特性：类静态初始化块</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/javascript_weekly/523/" class="sidebar-heading clickable"><span>JavaScript Weekly #523</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/javascript_weekly/523/undefined_VS_null.html" class="sidebar-link">null vs undefinded</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/javascript_weekly/399/" class="sidebar-heading clickable router-link-active open"><span>JavaScript Weekly #399</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/javascript_weekly/399/js_engine_optimizing_prototype.html" aria-current="page" class="active sidebar-link">JavaScript引擎基础(下)：优化原型</a></li><li><a href="/javascript_weekly/399/js_engine_shape_and_inline_caches.html" class="sidebar-link">JavaScript引擎基础(上)：形态和内联缓存</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-25ba6db2 data-v-130b300a><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>JavaScript引擎基础(下)：优化原型</h3> <!----> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><!---->
            
          <!---->
          2022
        </a></span></div></div> <div data-v-130b300a><main class="page"><section><div class="page-title"><h1 class="title">JavaScript引擎基础(下)：优化原型</h1> <div data-v-f875f3fc><!----> <i class="iconfont reco-date" data-v-f875f3fc><span data-v-f875f3fc>2018/8/17</span></i> <!----> <i class="tags iconfont reco-tag" data-v-f875f3fc><span class="tag-item" data-v-f875f3fc>JavaScript</span></i></div></div> <div class="theme-reco-content content__default"><p>本文描述 JavaScript 引擎中通用的一些关键的基础知识——不仅仅是 <a href="https://twitter.com/v8js" target="_blank" rel="noopener noreferrer">V8<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。作为一名 JavaScript 开发人员，对 JavaScript 引擎的工作原理深入了解一下有助于你更好的编写代码。</p> <p><strong>如果你没有看<a href="https://github.com/FEDarling/weekly-tracker/blob/master/JavaScript_Weekly/399/js_engine_shape_and_inline_caches.md" target="_blank" rel="noopener noreferrer">之前的文章：JavaScript 引擎基础(上)：形态和内联缓存<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，请务必看下，本篇有很多相关名词在前文都有介绍。</strong></p> <p>之前的文章，我们讨论了 JavaScript 引擎如何通过使用 <strong>Shape</strong> 和 <strong>内联缓存</strong> 来优化对象和数组访问。本文来说一下如何优化 管道(pipeline) 的权衡，并会讲述引擎如何加快对原型属性的访问。</p> <h2 id="优化层级和执行权衡"><a href="#优化层级和执行权衡" class="header-anchor">#</a> 优化层级和执行权衡</h2> <p><a href="https://github.com/FEDarling/weekly-tracker/blob/master/JavaScript_Weekly/399/js_engine_shape_and_inline_caches.md" target="_blank" rel="noopener noreferrer">之前的文章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>讨论了现代 JavaScript 引擎如何拥有相同的管道：</p> <p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/20220113220830.png" alt=""></p> <p>我们还提出了，虽然引擎之间的高层管道有点类似，但优化管道这方面往往存在差异。这是为什么？为什么有些引擎比其他引擎有更多的优化层级？事实证明，在运行代码的最快速度和最佳性能之间存在着某种权衡：</p> <p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/20220114004905.png" alt=""></p> <p>解释器可以快速生成字节码，但字节码通常效率不高。另一方面，优化编译器需要花更长的时间执行，不过最终会产生更高效的机器代码。</p> <p>这正是 V8 使用的模型。 V8 的解释器称为 <strong>火花塞(Ignition)</strong>，它是所有引擎中最快的解释器（就原始字节码执行速度而言）。 V8 的优化编译器名为 <strong>涡轮风扇(TurboFan)</strong>，它最终会生成高度优化的机器代码：</p> <p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/20220114005049.png" alt=""></p> <p>启动延迟和执行速度之间的权衡是一些 JavaScript 引擎选择在两者之间添加优化层的原因。例如，SpiderMonkey 在解释器和 IonMonkey 优化编译器之间添加了一个基准层：</p> <p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/20220114005201.png" alt=""></p> <p>解释器快速生成字节码，但字节码执行速度相对较慢。 Baseline 生成代码虽然需要更长的时间，但它提供了更好的运行时性能。最后，IonMonkey 优化编译器生成机器代码的时间最长，不过该代码可以非常高效地运行。</p> <p>让我们看一个具体的例子，看看不同引擎中的管道如何处理它。这是一些在热循环中经常重复的代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4242424242</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">+=</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>V8 开始在 <strong>火花塞(Ignition)</strong> 解释器中运行字节码。在某个时刻，引擎确定代码达到了 hot 的程度，并启动 <strong>涡轮风扇(TurboFan)</strong>，这是 <strong>涡轮风扇(TurboFan)</strong> 处理集成分析数据和构建代码的基本机器表示的部分。然后将其发送到不同线程上的 <strong>涡轮风扇(TurboFan)</strong> 优化器以进行进一步改进：</p> <p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/20220114005434.png" alt=""></p> <p>当优化器运行时，V8 继续在 <strong>火花塞(Ignition)</strong> 中执行字节码。在某些时候优化器完成了，我们有了可执行的机器代码，并且可以继续执行。</p> <blockquote><p>从 Chrome 91（2021 年发布）开始，V8 在 Ignition 解释器和 TurboFan 优化编译器之间增加了一个名为 Sparkplug 的编译器。</p></blockquote> <p>SpiderMonkey 引擎也开始在解释器中运行字节码。但它有额外的基准层，这意味着热代码首先发送到基准层，基准编译器在主线程上生成基准代码并在准备好后继续执行。</p> <p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/20220114005609.png" alt=""></p> <p>基准代码运行一段时间后，SpiderMonkey 最终会启动 IonMonkey，并启动优化器 — 这与 V8 非常相似。在 IonMonkey 进行优化时，它会继续在基准层中运行。最后，当优化器完成时，将会执行优化代码而不是基准代码。</p> <p>Chakra 的架构与 SpiderMonkey 的架构非常相似，但 Chakra 会尝试同时运行更多的东西以避免阻塞主线程。 Chakra 没有在主线程上运行编译器的任何部分，而是复制出编译器可能需要的字节码和数据，并将其发送到专用的编译器进程：</p> <p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/20220114005732.png" alt=""></p> <p>当生成的代码准备好后，引擎开始运行这个 SimpleJIT 代码而不是字节码。 FullJIT 也是如此。这种方法的好处是，与运行 FullJIT 编译器相比，复制发生的暂停时间通常要短得多。但这种方法的缺点是这种复制可能会遗漏某些优化所需的信息，因此它会在某种程度上降低代码质量来换取延迟。</p> <p>在 JavaScriptCore 中，所有优化编译器与主线程 JavaScript <strong>完全并发</strong> 运行，注意！这里没有复制！相反，主线程仅触发另一个线程上的编译作业。然后编译器使用复杂的锁定方案从主线程访问分析数据：</p> <p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/20220114010056.png" alt=""></p> <p>这种方法的优点是它减少了由于 JavaScript 优化在主线程上引起的卡顿，缺点是它需要处理复杂的多线程问题并为各种操作付出一些锁定的成本。</p> <p>到这里为止，我们已经讨论了使用解释器快速生成代码或使用优化编译器生成快速代码之间的权衡。但是还有另一个权衡：<strong>内存使用</strong>！为了说明这一点，下面是一个代码例子，它将两个数字相加：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这是我们使用 V8 中的 Ignition 解释器为 add 函数生成的字节码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>StackCheck
Ldar a1
Add a0<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
Return
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>不用完全看懂字节码</strong>，可以简单看出它只有四个指令。</p> <p>当代码状态变成 hot 时，TurboFan 会生成以下高度优化的机器码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>leaq rcx<span class="token punctuation">,</span><span class="token punctuation">[</span>rip<span class="token operator">+</span><span class="token number">0x0</span><span class="token punctuation">]</span>
movq rcx<span class="token punctuation">,</span><span class="token punctuation">[</span>rcx<span class="token operator">-</span><span class="token number">0x37</span><span class="token punctuation">]</span>
testb <span class="token punctuation">[</span>rcx<span class="token operator">+</span><span class="token number">0xf</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x1</span>
jnz CompileLazyDeoptimizedCode
push rbp
movq rbp<span class="token punctuation">,</span>rsp
push rsi
push rdi
cmpq rsp<span class="token punctuation">,</span><span class="token punctuation">[</span>r13<span class="token operator">+</span><span class="token number">0xe88</span><span class="token punctuation">]</span>
jna StackOverflow
movq rax<span class="token punctuation">,</span><span class="token punctuation">[</span>rbp<span class="token operator">+</span><span class="token number">0x18</span><span class="token punctuation">]</span>
test al<span class="token punctuation">,</span><span class="token number">0x1</span>
jnz Deoptimize
movq rbx<span class="token punctuation">,</span><span class="token punctuation">[</span>rbp<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">]</span>
testb rbx<span class="token punctuation">,</span><span class="token number">0x1</span>
jnz Deoptimize
movq rdx<span class="token punctuation">,</span>rbx
shrq rdx<span class="token punctuation">,</span> <span class="token number">32</span>
movq rcx<span class="token punctuation">,</span>rax
shrq rcx<span class="token punctuation">,</span> <span class="token number">32</span>
addl rdx<span class="token punctuation">,</span>rcx
jo Deoptimize
shlq rdx<span class="token punctuation">,</span> <span class="token number">32</span>
movq rax<span class="token punctuation">,</span>rdx
movq rsp<span class="token punctuation">,</span>rbp
pop rbp
ret <span class="token number">0x18</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>哇，好多字节码！一般来说，字节码往往比机器码更紧凑，尤其是优化的机器码。另一方面，字节码需要解释器才能运行，而优化后的代码可以直接由处理器执行。</p> <p>这也是为什么 JavaScript 引擎不只有“优化所有代码”。正如我们之前看到的，生成优化的机器码需要很长时间，最重要的是，我们刚刚了解到 <strong>优化的机器码也需要更多的内存</strong>。</p> <p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/20220114010613.png" alt=""></p> <blockquote><p>简介： JavaScript 引擎具有很多的优化层的原因是因为需要使用解释器快速生成代码，也需要使用优化编译器生成快速代码。这是一个范围化的东西，添加更多优化层可以让你从 <strong>额外的复杂性/开销</strong> 和 <strong>更细粒度的决策</strong> 之间做出自己的选择。此外，<strong>优化的级别</strong> 和 <strong>生成代码的内存使用</strong> 之间也存在权衡。这就是 JavaScript 引擎尝试 <strong>只优化热函数(hot function)</strong> 的原因。</p></blockquote> <h2 id="优化原型属性访问"><a href="#优化原型属性访问" class="header-anchor">#</a> 优化原型属性访问</h2> <p><a href="https://github.com/FEDarling/weekly-tracker/blob/master/JavaScript_Weekly/399/js_engine_shape_and_inline_caches.md" target="_blank" rel="noopener noreferrer">之前的文章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 解释了 JavaScript 引擎如何使用 Shapes 和 IC 优化对象属性加载。回顾一下，引擎将对象的 Shape 与 对象的值 分开存储：</p> <p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/20220114011019.png" alt=""></p> <p>Shapes 支持一种称为 <strong>行内缓存(Inline Caches，IC)</strong> 的优化。结合起来，Shapes 和 IC 可以加快代码中同一位置的重复属性访问。</p> <p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/20220114011207.png" alt=""></p> <h3 id="类-classes-和基于原型-prototype-的编程"><a href="#类-classes-和基于原型-prototype-的编程" class="header-anchor">#</a> 类(Classes)和基于原型(prototype)的编程</h3> <p>现在我们知道了如何在 JavaScript 对象上快速访问属性，让我们看看 JavaScript 中最近添加的一个：类(Classes)。 JavaScript 类语法如下所示：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Bar</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>尽管这似乎是 JavaScript 中的一个新概念，但它只是基于原型的编程的语法糖，一直在 JavaScript 中使用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Bar</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">Bar</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getX</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在这里，我们在 <code>Bar.prototype</code> 对象上分配了一个 <code>getX</code> 属性。这与任何其他对象的工作方式完全相同，因为原型也只是 JavaScript 中的对象！在 JavaScript 等一系列基于原型的编程语言中，方法通过原型共享，而字段存储在具体的实例中。</p> <p>当我们创建一个名为 <code>foo</code> 的新 <code>Bar</code> 实例时，看看幕后发生了什么：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>运行上面的代码创建的实例具有单个属性 <code>“x”</code> 的 Shape。 <code>foo</code> 的原型是 <code>Bar</code> 类的 <code>Bar.prototype</code>：</p> <p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/20220114011543.png" alt=""></p> <p><code>Bar.prototype</code> 有它自己的 Shape，包含一个属性 <code>“getX”</code>，属性的值是函数 <code>getX</code>，它在调用时只返回 <code>this.x</code>。 <code>Bar.prototype</code> 的原型是 JavaScript 语言的 <code>Object.prototype</code>。<code>Object.prototype</code> 是原型树的根，因此它的原型为 <code>null</code>。</p> <p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/20220114011752.png" alt=""></p> <p>如果你创建了另一个类的另一个实例，则两个实例都在我们之前讨论的情况下共享对象 Shape：两个实例都指向同一个 <code>Bar.prototype</code> 对象。</p> <h3 id="原型属性访问"><a href="#原型属性访问" class="header-anchor">#</a> 原型属性访问</h3> <p>好的，现在我们知道当我们定义一个类并创建一个新的实例时会发生什么。但是如果我们在实例上调用方法又会发生什么呢？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Bar</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> x <span class="token operator">=</span> foo<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        ^^^^^^^^^^</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>我们把它拆分一下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> x <span class="token operator">=</span> foo<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 其实就是两步</span>

<span class="token keyword">const</span> $getX <span class="token operator">=</span> foo<span class="token punctuation">.</span>getX<span class="token punctuation">;</span>
<span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">$getX</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>第 1 步是加载方法，它只是原型上的一个属性（其值恰好是一个函数），第 2 步是以值为 <code>this</code> 的实例调用函数。让我们来看看第一步，即从实例 <code>foo</code> 加载方法 <code>getX</code>：</p> <p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/20220114012125.png" alt=""></p> <p>引擎从 <code>foo</code> 实例开始，并发现 <code>foo</code> 的 Shape 上没有 <code>'getX'</code> 属性，因此它必须遍历原型链。我们到达 <code>Bar.prototype</code>，查看它的原型 Shape，看到它在 offset <code>0</code> 处具有 <code>“getX”</code> 属性。我们在 <code>Bar.prototype</code> 中查找此 offset 处的值，并找到我们正在寻找的 <code>JSFunction getX</code>。整个过程就是这样！</p> <p>JavaScript 可以用自己特有的灵活性改变原型链链接，例如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
foo<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// → true</span>

Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>foo<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
foo<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// → Uncaught TypeError: foo.getX is not a function</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在这个例子中，我们调用了 <code>foo.getX()</code> 两次，但每次它的含义和结果都完全不同。这就是为什么？虽然原型只是 JavaScript 中的对象，但对于 JavaScript 引擎来说，加速原型属性访问比加速常规对象上自己的属性访问更有难度。</p> <p>看看这个代码，加载原型属性是一个非常频繁的操作：每次调用方法时都会发生！</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Bar</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> x <span class="token operator">=</span> foo<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        ^^^^^^^^^^</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>之前，我们讨论了引擎如何通过使用 Shape 和 内联缓存 来优化加载常规的、自己的属性。那我们如何优化重复加载具有相似 Shape 的对象的原型属性？上面的图中我们看到了属性加载是如何发生的：</p> <p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/20220114012605.png" alt=""></p> <p>为了在这种特殊情况下加快重复加载速度，我们需要知道这三点：</p> <ol><li><code>foo</code> 的 Shape 不包含 <code>'getX'</code> 并且没有做改变。这意味着没有人通过添加、删除或更改属性来更改对象 <code>foo</code>。</li> <li><code>foo</code> 的原型仍然是最初的 <code>Bar.prototype</code>。这意味着没有人通过使用 <code>Object.setPrototypeOf()</code> 或设置特殊的 <code>__proto__</code> 属性来更改 <code>foo</code> 原型。</li> <li><code>Bar.prototype</code> 的 Shape 包含 <code>“getX”</code> 并且没有做改变。这意味着没有人通过添加、删除、或更改属性之来修改 <code>Bar.prototype</code>。</li></ol> <p>在一般情况下，这意味着我们必须对实例本身执行 1 次检查，再加上每个原型的 2 次检查，直到拥有我们正在寻找的属性的原型。 1+2N 检查（N 是涉及的原型的数量）在这种情况下可能听起来并不算太坏，因为原型链相对较浅 — 但引擎通常必须处理更长的原型链，例如在常见 DOM 的情况下类。就像下面这个例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> anchor <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// → HTMLAnchorElement</span>

<span class="token keyword">const</span> title <span class="token operator">=</span> anchor<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>我们有一个 <code>HTMLAnchorElement</code> 并在其上调用 <code>getAttribute()</code> 方法。这已经涉及到 6 个原型！大多数好用的 DOM 方法不在直接的 <code>HTMLAnchorElement</code> 原型上，而是在链的更高层：</p> <p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/20220114013048.png" alt=""></p> <p><code>getAttribute()</code> 方法可以在 <code>Element.prototype</code> 上找到。这意味着每次我们调用 <code>anchor.getAttribute()</code> 时，JavaScript 引擎需要做.....</p> <ol><li>检查 <code>“getAttribute”</code> 是否不在 <code>anchor</code> 对象本身上</li> <li>检查直接原型是 <code>HTMLAnchorElement.prototype</code></li> <li>确定那里没有“<code>getAttribute”</code></li> <li>检查下一个原型是<code>HTMLElement.prototype</code></li> <li>确定那里也没有 <code>“getAttribute”</code></li> <li>最终检查下一个原型是 <code>Element.prototype</code></li> <li>并且那里存在 <code>“getAttribute”</code></li></ol> <p>总共有 <strong>7</strong> 次检查！这种代码在网络上很常见，引擎会应用一些技巧来减少原型上属性加载所需的检查次数。</p> <p>再回到前面的例子，我们在 <code>foo</code> 上访问 <code>'getX'</code> 时总共执行了 3 次检查：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Bar</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> $getX <span class="token operator">=</span> foo<span class="token punctuation">.</span>getX<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>每个携带该属性的原型对象，都需要进行 Shape 检查以查找是否缺失。如果我们可以通过把 <strong>原型检查</strong> 变成 <strong>缺勤检查</strong>， 以此来减少检查次数，那就太棒了。本质上这就是引擎使用了一个简单技巧做的事情：引擎不是将原型链存储在实例本身上，而是将其存储在 <strong>Shape</strong> 中。</p> <p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/20220114014249.png" alt=""></p> <p>每个 Shape 都指向了原型。这也意味着每次 <code>foo</code> 的原型发生变化时，引擎都会转换为新的 Shape。现在我们只需要检查一个对象的 Shape 来断言某些属性是否缺失并保护原型链接。</p> <p>通过这种方法，我们可以将所需的检查次数从 <strong>1+2N</strong> 减少到 1+N，从而更快地访问原型的属性。但这种方式代价也不小，原型链越长，代价也越高。引擎实现了不同的技巧来进一步减少检查的数量，特别是对于相同属性加载的后续执行。</p> <h3 id="有效单元格-validitycell"><a href="#有效单元格-validitycell" class="header-anchor">#</a> 有效单元格(ValidityCell)</h3> <p>V8 专门为这种原型 Shape 做处理。每个原型都有一个独特的 Shape，它不与任何其他对象共享（特别是不与其他原型共享），并且这些原型 Shape 中的每一个都有一个与之关联的特殊的 <strong>有效单元格(ValidityCell)</strong>。</p> <p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/20220114014721.png" alt=""></p> <p>每当有人更改相关原型或它上面的任何原型时，此 ValidityCell 都会失效。让我们来看看它是如何工作的。</p> <p>为了加快原型的后续加载，V8 放置了一个内联缓存，其中包含四个字段：</p> <p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/20220114014830.png" alt=""></p> <p>在这段代码的第一次运行到预热内联缓存时，V8 会记住在原型中找到属性的 offset、找到属性的原型（当前是 <code>Bar.prototype</code>）、实例的 Shape（当前是 foo 的 Shape），以及从实例 Shape 链接到的直接原型的当前 ValidityCell 的链接（当前是 <code>Bar.prototype</code> ）。</p> <p>下次命中内联缓存时，引擎必须检查实例的 Shape 和 ValidityCell。如果它仍然有效，引擎可以直接访问原型上的 offset，跳过额外的查找：</p> <p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/20220114015217.png" alt=""></p> <p>当原型发生变化时，分配一个新的 Shape，之前的 ValidityCell 就失效了。所以 Inline Cache 在下次执行时会丢失，导致性能变差。</p> <p>回到之前的 DOM 元素示例，这意味着对 <code>Object.prototype</code> 来说，不仅会使 <code>Object.prototype</code> 本身的内联缓存失效，还会使下面的任何原型失效，包括 <code>EventTarget.prototype</code>、<code>Node.prototype</code>、<code>Element.prototype</code> 等，一直到 <code>HTMLAnchorElement.prototype</code>：</p> <p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/20220114015338.png" alt=""></p> <p>实际上，在运行代码时修改 <code>Object.prototype</code> 意味着优先不考虑性能。尽量不要这样做！</p> <p>让我们通过一个具体的例子来进一步探讨这一点。假设我们有我们的类 <code>Bar</code>，并且我们有一个函数 <code>loadX</code>，它调用 <code>Bar</code> 对象的方法。我们用同一个类的实例多次调用这个 loadX 函数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Bar</span> <span class="token punctuation">{</span>
    <span class="token comment">/* … */</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">loadX</span><span class="token punctuation">(</span><span class="token parameter">bar</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> bar<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Bar 实例上的 getX 的 IC。</span>
<span class="token punctuation">}</span>

<span class="token function">loadX</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">loadX</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// loadX 中的 IC 现在为 Bar.prototype 链接 ValidityCell。</span>

<span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">newMethod</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> y<span class="token punctuation">;</span>
<span class="token comment">// loadX IC中的 ValidityCell 现在无效，</span>
<span class="token comment">// 因为 Object.prototype 发生了变化。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><code>loadX</code> 中的内联缓存现在指向 <code>Bar.prototype</code> 的 ValidityCell。如果你之后做一些像改变 <code>Object.prototype</code> 之类的事情。ValidityCell 就会失效，并且现有的内联缓存在下次被命中时会丢失，从而导致性能下降。</p> <p>尽量不要改变 <code>Object.prototype</code> ，因为它会使引擎在此之前放置的原型加载的任何内联缓存失效。这是另一个错误的例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* … */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

someObject<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">delete</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>foo<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>我们扩展了 <code>Object.prototype</code>，它使引擎在此之前放置的任何原型内联缓存都失效。然后我们运行一些使用新原型方法的代码。引擎必须从头开始并为所有原型属性访问设置新的内联缓存。最后，我们 “自行清理” 并删除我们之前添加的原型方法。</p> <p>“自行清理” 看起来不错，但是在这种情况下，它会使情况变得更糟！删除该属性会修改 <code>Object.prototype</code>，因此所有内联缓存都会再次失效，引擎必须再次从头开始。</p> <blockquote><p>总结：虽然原型只是对象，但它们被 JavaScript 引擎特殊处理，从而优化原型上方法查找的性能。别管你的原型了！或者，如果你真的需要接触原型，那么在其他代码运行之前进行操作，这样你至少不会在代码运行时使引擎中的所有优化无效。</p></blockquote> <h2 id="最后"><a href="#最后" class="header-anchor">#</a> 最后</h2> <p>我们已经了解了 JavaScript 引擎如何存储对象和类，以及 Shapes、Inline Caches 和 ValidityCells 如何帮助优化原型操作。基于这些知识，我们确定了一个实用的 JavaScript 编码技巧，可以帮助提高性能：不要弄乱原型（或者如果你真的非常需要，那么至少在其他代码运行之前这样做）。</p> <hr> <blockquote><ul><li>译文出自：<a href="https://github.com/FEDarling/weekly-tracker" target="_blank" rel="noopener noreferrer">weekly-tracker<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 项目，期待你的加入！</li> <li><a href="https://mathiasbynens.be/notes/prototypes" target="_blank" rel="noopener noreferrer">查看原文<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>对比阅读</li> <li>发现错误？<a href="https://github.com/FEDarling/weekly-tracker/blob/main/weeklys/javascript_weekly/399/js_engine_optimizing_prototype.md" target="_blank" rel="noopener noreferrer">提交 PR<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>译者：<a href="https://github.com/daodaolee" target="_blank" rel="noopener noreferrer">daodaolee<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>校对者：<a href="https://github.com/daodaolee" target="_blank" rel="noopener noreferrer">daodaolee<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></blockquote></div></section> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/FEDarling/weekly-tracker/edit/main/weeklys/javascript_weekly/399/js_engine_optimizing_prototype.md" target="_blank" rel="noopener noreferrer">发现错误？欢迎斧正</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">最后更新时间: </span> <span class="time">2022/10/14 上午1:59:14</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/javascript_weekly/523/undefined_VS_null.html" class="prev">
            null vs undefinded
          </a></span> <span class="next"><a href="/javascript_weekly/399/js_engine_shape_and_inline_caches.html">
            JavaScript引擎基础(上)：形态和内联缓存
          </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-cb1513f6><li class="level-2" data-v-cb1513f6><a href="/javascript_weekly/399/js_engine_optimizing_prototype.html#优化层级和执行权衡" class="sidebar-link reco-side-优化层级和执行权衡" data-v-cb1513f6>优化层级和执行权衡</a></li><li class="level-2" data-v-cb1513f6><a href="/javascript_weekly/399/js_engine_optimizing_prototype.html#优化原型属性访问" class="sidebar-link reco-side-优化原型属性访问" data-v-cb1513f6>优化原型属性访问</a></li><li class="level-3" data-v-cb1513f6><a href="/javascript_weekly/399/js_engine_optimizing_prototype.html#类-classes-和基于原型-prototype-的编程" class="sidebar-link reco-side-类-classes-和基于原型-prototype-的编程" data-v-cb1513f6>类(Classes)和基于原型(prototype)的编程</a></li><li class="level-3" data-v-cb1513f6><a href="/javascript_weekly/399/js_engine_optimizing_prototype.html#原型属性访问" class="sidebar-link reco-side-原型属性访问" data-v-cb1513f6>原型属性访问</a></li><li class="level-3" data-v-cb1513f6><a href="/javascript_weekly/399/js_engine_optimizing_prototype.html#有效单元格-validitycell" class="sidebar-link reco-side-有效单元格-validitycell" data-v-cb1513f6>有效单元格(ValidityCell)</a></li><li class="level-2" data-v-cb1513f6><a href="/javascript_weekly/399/js_engine_optimizing_prototype.html#最后" class="sidebar-link reco-side-最后" data-v-cb1513f6>最后</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><!----><!----></div></div>
    <script src="/assets/js/app.753e2338.js" defer></script><script src="/assets/js/4.c9e0fe93.js" defer></script><script src="/assets/js/1.fdc351be.js" defer></script><script src="/assets/js/95.349d6786.js" defer></script><script src="/assets/js/10.830b4516.js" defer></script>
  </body>
</html>
